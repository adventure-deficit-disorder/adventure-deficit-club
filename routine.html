<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Velocity — Life Balance Visualizer + Velocity Table (Stateless)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#11192b; --line:#22314d; --text:#dbe7ff; --muted:#8aa1c9; --accent:#20a5a5;
      --table-bg:#11192b; --input-bg:#11192b;
    }
    html,body{background:var(--bg); color:var(--text);}
    .navbar{background:linear-gradient(90deg,#0b1220 0%, #0e1830 60%, #0b1220 100%); border-bottom:1px solid var(--line);}
    .container-narrow{max-width:1040px;}
    .card{background:var(--card); border:1px solid var(--line); color:white ;}
    .card h6, .list-group-item { color: #4da98a; }
    .btn-accent{background:var(--accent); color:#08121f; border:1px solid #128b8b;}
    .metric-pill{display:flex; justify-content:space-between; align-items:center; border:1px dashed var(--line); border-radius:999px; padding:.35rem .75rem; }
    .range-track::-webkit-slider-thumb{cursor:pointer;}
    .vis-wrap{border:1px solid var(--line); border-radius:.75rem; overflow:hidden; background:#0c1526;}
    .node-label{fill:var(--text); font-size:12px; text-anchor:middle; pointer-events:none;}
    .edge{stroke:#6c7a99; stroke-width:2; opacity:.25;}
    .node{stroke:#0b1220; stroke-width:2;}
    .pill{border:1px solid var(--line); border-radius:999px; padding:.1rem .5rem; font-size:.8rem; color:var(--muted);}
    .legend-dot{display:inline-block; width:.8rem; height:.8rem; border-radius:50%; margin-right:.4rem; vertical-align:middle;}
    .legend{display:flex; gap:.75rem; flex-wrap:wrap;}
    .export-bar .btn{min-width:10rem;}

    .vt-table .table{background:var(--table-bg); border-color:var(--line);}
    .vt-table thead th{background:var(--table-bg); color:#cfe1ff; border-color:var(--line);}
    .vt-table tbody td,.vt-table tbody th{color:#e7efff; background:var(--table-bg); border-color:var(--line); vertical-align:middle;}
    .vt-table .table-hover tbody tr:hover{background:rgba(32,165,165,.10)}
    .vt-input{background:var(--input-bg)!important; color:#fff!important; border:1px solid #27324b;}
    .vt-input::placeholder{color:#c4d0f0;}
    .offcanvas{background:var(--card); color:var(--text); border-left:1px solid var(--line);}
    .tiny{font-size:.85rem; color:var(--muted)}

    @media (max-width: 767.98px){
      .vt-table{display:none}
      #vtList{display:block}
    }
    @media (min-width: 768px){
      #vtList{display:none}
    }

/* Dark legibility patch */
:root {
  --bg-deep: #0b1220;
  --bg-card: #0f1626;
  --bg-card-2: #121a2b;
  --fg-base: #e6edf3;
  --fg-dim: #c2ccda;
  --fg-muted: #9fb0cc;
  --border-1: #27324b;
  --border-2: #33415e;
}
body { color: var(--fg-base); }
.card { background: var(--bg-card); }
.metric-pill { background: var(--bg-card-2); border: 1.25px dashed var(--border-2); padding: 8px 10px; border-radius: 999px; }
.metric-pill .k { font-size: 0.9rem; color: var(--fg-muted); }
.metric-pill .v { font-weight: 600; font-size: 1.1rem; }
.card table { width: 100%; border-collapse: collapse; font-size: 12px; color: var(--fg-base); }
.card table thead th { background: var(--bg-card-2); color: var(--fg-base); padding: 10px 12px; border: 1.25px solid var(--border-1); text-align: left; font-size:12px; }
.card table tbody td { padding: 10px 12px; border: 1.25px solid var(--border-1); }
.card table tbody tr:nth-child(odd) { background: var(--bg-card); }
.card table tbody tr:nth-child(even){ background: #0e1525; }
.card table td:nth-last-child(1), .card table th:nth-last-child(1){ text-align: right; font-variant-numeric: tabular-nums; }
.tiny { color: var(--fg-muted); font-size: .85rem; }
.node-label { fill: var(--fg-base); paint-order: stroke; stroke: rgba(0,0,0,.35); stroke-width: 2px; font-size: 14px; }
#edgeLegendHint { color: var(--fg-muted); }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark">
    <div class="container container-narrow text-md-start text-center d-flex flex-md-row flex-column align-items-md-end align-items-center justify-content-between py-2 gap-2">
        <div>
            <a class="navbar-brand" href="#">Adventure Deficit Club</a>
            <h6>Procrastination | Perfectionism | Fatigue</h6>
        </div>
        <div class="campfire-bar d-flex align-items-center justify-content-between  border-0 gap-2">
        <p class="mb-0 text-light">"Are you feeling tired of starting over, giving up, and remining stuck?"</p>
        <a class="mb-0 h6 d-flex flex-column" href="https://www.skool.com/adventure-deficit-club-8261"><mark class="px-2">Join The Club</mark></a>
        </div>
    </div>
  </nav>

  <main class="container container-narrow my-4">

    <!-- Overview -->
    <nav class="card my-3 text-light">
      <div class="card-header bg-transparent p-0">
        <button class="btn d-flex w-100 justify-content-between align-items-center px-4 py-3 text-start text-light"
          type="button" data-bs-toggle="collapse" data-bs-target="#dailyOutputPanel" aria-expanded="true" aria-controls="dailyOutputPanel"
          style="background:#0b1220;border:none;">
          <span>
            <span class="kicker text-uppercase d-block small mb-1 text-warning">Directives</span>
            <h2 class="fw-bold">Daily Routine Builder</h2>
          </span>
          <span class="chev ms-3 badge bg-warning text-dark" aria-hidden="true">▾</span>
        </button>
      </div>
      <div id="dailyOutputPanel" class="collapse hide">
        <div class="card-body p-4">
            <div class="row">
              <div class="col my-4">
                <h3 class="mb-2 text-light">Directives</h3>
                <h6 class="m-0 text-light mb-4">Strategies For Balancing Stress, Energy, Complexity, Support And Efficacy</h6>
                <ol class="list-group list-group-numbered bg-dark text-light" style="background-color:#0c1526">
                  <li class="list-group-item lh-lg  border-secondary" style="background-color:#0c1526">
                    <strong>Track patterns, not moods</strong>
                    <div class="small text-light">Velocity comes from proof of motion. Measure what repeats, not what you feel.</div>
                  </li>
                  <li class="list-group-item lh-lg  border-secondary" style="background-color:#0c1526">
                    <strong>Balance energy across domains</strong>
                    <div class="small text-light">Mind, Body, Money, and Relationships reinforce or drain one another — keep them in sync.</div>
                  </li>
                  <li class="list-group-item lh-lg  border-secondary" style="background-color:#0c1526">
                    <strong>Design friction out</strong>
                    <div class="small text-light">If it takes too much setup, it won’t sustain. Automate, template, or batch it.</div>
                  </li>
                  <li class="list-group-item lh-lg  border-secondary" style="background-color:#0c1526">
                    <strong>Let data replace doubt</strong>
                    <div class="small text-light">Every routine gives feedback. Use numbers to steer, not emotions to guess.</div>
                  </li>
                  <li class="list-group-item lh-lg  border-secondary" style="background-color:#0c1526">
                    <strong>Protect minimum viable motion</strong>
                    <div class="small text-light">When energy is low, do the smallest version that keeps the chain alive.</div>
                  </li>
                  <li class="list-group-item lh-lg  border-secondary" style="background-color:#0c1526">
                    <strong>Use leverage as your compass</strong>
                    <div class="small text-light">High leverage routines amplify others. Prioritize what multiplies, not what merely adds.</div>
                  </li>
                  <li class="list-group-item lh-lg  border-secondary" style="background-color:#0c1526">
                    <strong>Audit complexity weekly</strong>
                    <div class="small text-light">Every routine adds maintenance. Trim or merge low-impact loops before they stall momentum.</div>
                  </li>
                  <li class="list-group-item lh-lg  border-secondary" style="background-color:#0c1526">
                    <strong>Build proof before pride</strong>
                    <div class="small text-light">Momentum is earned through consistency, not confidence. Let output earn belief.</div>
                  </li>
                  <li class="list-group-item lh-lg  border-secondary" style="background-color:#0c1526">
                    <strong>Translate friction into structure</strong>
                    <div class="small text-light">Where effort spikes, add scaffolding — checklists, templates, or scheduled cues.</div>
                  </li>
                  <li class="list-group-item lh-lg  border-secondary" style="background-color:#0c1526">
                    <strong>Velocity > Intensity</strong>
                    <div class="small text-light">Slow consistent motion beats bursts and collapse. Keep moving; refine later.</div>
                  </li>
                </ol>

              </div>
            </div>

        </div>
      </div>
    </nav>

    <!-- Velocity Table -->
    <section class="mb-4">
      <div class="card">
        <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center p-4">
          <p class="mb-0 text-light d-flex justify-content-center align-items-center gap-2 lead">
            <span class="badge text-bg-warning"> 1</span><Strong class="h4 mb-0 text-warning fw-semibold"> Daily Routine -</Strong> Align Long-term Goals With Short-term Actions</p>
          <div class="btn-group btn-group-sm" role="group">
            <button id="addRow" class="btn btn-sm btn-outline-light">+ Add Routine</button>
<button id="btnImport" class="btn btn-sm btn-outline-light">Import CSV</button>
<input type="file" id="fileCsv" accept=".csv,text/csv" class="d-none" />
            <div class="btn-group">
              <button id="btnExport" type="button" class="btn btn-sm btn-outline-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                Export
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" id="actExportPng">PNG (Velocity Table)</a></li>
                <li><a class="dropdown-item" href="#" id="actExportCsv">Spreadsheet (CSV)</a></li>
              </ul>
            </div>
            <button id="btnDeleteAll" class="btn btn-sm btn-outline-danger">Delete All</button>
          </div>
        </div>
        <div class="card-body">
          <!-- Desktop/Table view -->
          <div class="card vt-table">
            <div class="table-responsive">
              <table id="velocityTable" class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th>Five Year Outcome</th>
                    <th>1 Year Goal</th>
                    <th>Routine</th>
                    <th>Time Block</th>
                    <th style="width:90px">Min</th>
                    <th style="width:90px">Last</th>
                    <th style="width:90px">Max</th>
                    <th>Leverage</th>
                    <th>Leverage Score (1–5)</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="p-2 tiny">Tip: Click any row to edit; Save in the panel.</div>
          </div>

          <!-- Mobile list view -->
          <div id="vtList" class="vstack gap-2"></div>
        </div>
      </div>
    </section>

    <!-- Complexity Widget -->
    <section class="mb-5">
      <div class="row g-3">
        <div class="col-12 col-md-5">
          <div class="card p-3">
          <p class="mb-0 text-light d-flex justify-content-start align-items-center gap-2 lead">
            <span class="badge text-bg-warning"> 2</span><Strong class="h4 mb-0 text-warning fw-semibold">Complexity</Strong></p>
          <div class="row row-cols-2 gy-2 gx-2 mt-1 text-light">
              <div class="col"><div class="metric-pill"><div class="k">Processes (n)</div><div class="v text-light" id="m_n">0</div></div></div>
              <div class="col"><div class="metric-pill"><div class="k">Interdependencies</div><div class="v text-light" id="m_edges">0</div></div></div>
              <div class="col"><div class="metric-pill"><div class="k">Maintainence (mins/day)</div><div class="v text-light" id="m_maint">0</div></div></div>
              <div class="col"><div class="metric-pill"><div class="k">Avg Leverage Score</div><div class="v text-light" id="m_lavg">—</div></div></div>
            </div>

            <label class="form-label mt-3 mb-1 text-light">Upkeep minutes per task</label>
            <div class="d-flex align-items-center gap-2 text-light">
              <input id="maintSlider" type="range" min="0" max="120" step="20" value="40" class="form-range range-track flex-grow-1" aria-label="Upkeep minutes per task">
              <output id="maintOut" class="badge bg-transparent border border-light text-light fw-bold" style="min-width:3.2rem; text-align:center;">40</output>
            </div>
            
            <div class="tiny mt-2">
              <strong>Node color = Leverage Score</strong> · 
              <span id="edgeLegendHint">Edges react to Upkeep per task + Interdependencies + total Maintenance.</span>
            </div>
            
<label class="form-label">ChatGPT Prompt (auto-generated)</label>
<textarea id="promptArea" class="form-control" rows="12" readonly></textarea>
<div class="d-flex align-items-center gap-2 mt-2">
  <button id="copyPrompt" class="btn btn-sm btn-accent" type="button">Copy Prompt</button>
  <small id="copyStatus" class="text-success d-none">Copied</small>
</div>
<small class="tiny">This prompt summarizes your goals, routines, and current complexity math so ChatGPT can use the Socratic method to help you maximize leverage (0–5) and minimize interdependencies.
<label class="form-label mt-3">ChatGPT Prompt — Routine Spreadsheet (CSV)</label>
<textarea id="promptCsv" class="form-control" rows="8" readonly></textarea>
<div class="d-flex align-items-center gap-2 mt-2">
  <button id="copyPromptCsv" class="btn btn-sm btn-accent" type="button">Copy CSV Prompt</button>
  <small id="copyStatusCsv" class="text-success d-none">Copied</small>
</div>
<small class="tiny">Paste this into ChatGPT to generate a CSV with the exact headers the importer expects.</small>
</small>

          </div>
        </div>
        <div class="col-12 col-md-7">
          <div class="card p-3">
            <div class="vis-wrap">
              <svg id="graph" viewBox="0 0 1000 640" preserveAspectRatio="xMidYMid meet" aria-label="Complexity Node Graph">
                <g id="edges"></g><g id="nodes"></g><g id="labels"></g>
              </svg>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <small class="text-light">Links = n(n−1)/2. Labels = routines.</small>
              <small class="text-light">Powered by <strong>@AdventureDeficitClub</strong></small>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Velocity Table Editor -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="vtEditor" aria-labelledby="vtEditorLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="vtEditorLabel">Edit Routine</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <form id="vtForm" class="vstack gap-3">
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Output</label>
            <input list="outputOptions" class="form-control vt-input" id="f_output" placeholder="e.g., words, workouts, pages">
            <datalist id="outputOptions">
              <option value="words"></option>
              <option value="workouts"></option>
              <option value="pages"></option>
              <option value="videos"></option>
              <option value="calls"></option>
              <option value="leads"></option>
            </datalist>
          </div>
          <div class="col-6">
            <label class="form-label">Period</label>
            <select class="form-select vt-input" id="f_period">
              <option value="day">Day</option>
              <option value="week">Week</option>
              <option value="month">Month</option>
            </select>
          </div>
        </div>
        <div>
          <label class="form-label">Routine (auto)</label>
          <input type="text" class="form-control vt-input" id="f_routine" placeholder="e.g., words/day" readonly>
        </div>
        <div>
          <label class="form-label">Time Block</label>
          <input type="text" class="form-control vt-input" id="f_block" placeholder="e.g., 5:00–7:00 AM">
        </div>
        <div class="row g-2">
          <div class="col-4">
            <label class="form-label text-light text-opacity-75">Min</label>
            <input type="number" class="form-control vt-input" id="f_min" inputmode="numeric">
          </div>
          <div class="col-4">
            <label class="form-label">Last</label>
            <input type="number" class="form-control vt-input" id="f_last" inputmode="numeric">
          </div>
          <div class="col-4">
            <label class="form-label">Max</label>
            <input type="number" class="form-control vt-input" id="f_max" inputmode="numeric">
          </div>
        </div>
        <div>
          <label class="form-label">Leverage (text)</label>
          <input type="text" class="form-control vt-input" id="f_lev" placeholder="What increases payoff? (leave blank = score 0)">
          <div class="tiny">If this is empty, leverage score will be set to 0 automatically.</div>
        </div>
        <div>
          <label class="form-label">Leverage Score (0–5)</label>
          <input type="number" class="form-control vt-input" id="f_score" min="0" max="5" inputmode="numeric">
        </div>
        <div>
          <label class="form-label">1 Year Goal</label>
          <input type="text" class="form-control vt-input" id="f_goal1y" placeholder="Milestone by 12 months">
        </div>
        <div>
          <label class="form-label">Five Year Outcome</label>
          <input type="text" class="form-control vt-input" id="f_outcome" placeholder="What does this lead to?">
        </div>
        <div class="d-flex gap-2">
          <button type="button" id="saveRow" class="btn btn-success">Save</button>
          <button type="button" id="deleteRow" class="btn btn-outline-danger">Delete</button>
        </div>
        <div class="tiny">All inputs use <code>#11192b</code> background; text is white.</div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ==== Utility ====
    function $(id){ return document.getElementById(id); }

    // Score display: 0 if no leverage text present
    function getDisplayScore(row, autoScore){
      try{
        const hasLevText = row && row.lev && String(row.lev).trim().length > 0;
        if (!hasLevText) return 0;
        const s = Number(row && row.score);
        if (Number.isFinite(s) && s >= 0) return s;
        const a = Number(autoScore);
        return Number.isFinite(a) ? a : 0;
      }catch(e){ return 0; }
    }

    // Heuristic auto score (only used when text is present and user hasn't set one)
    function computeAutoScore(row, upkeep){
      const minV = Number(row.min)||0, lastV = Number(row.last)||0;
      const base = upkeep>0 ? (minV / upkeep) : 0;
      const curr = upkeep>0 ? (lastV / upkeep) : 0;
      let lift = (base>0) ? (curr / Math.max(base,1e-9)) : (curr>0?1.2:0.8);
      if ((row.lev||'').trim().length) lift *= 1.2;
      const score = 1 + 4 * Math.min(1, lift / 3.0);
      return Math.max(1, Math.min(5, Number(score.toFixed(1))));
    }

    function unitTagFor(row){
      const o = (row.output||'').toString().trim().toLowerCase();
      const p = (row.period||'').toString().trim().toLowerCase();
      if (!o || !p) return '';
      return ` (${o}/${p})`;
    }

    // ==== Sample Data ====
    const SAMPLE_ROWS = [
      { output:'words', period:'day', routine:'words/day', block:'5:30–7:00 AM', min:300, last:700, max:1200, lev:'AI outline + Pomodoro + keyboard macro', score:4, goal1y:'Publish 12 long-form essays', outcome:'Nonfiction book + lead gen' },
      { output:'workouts', period:'week', routine:'workouts/week', block:'6:00–7:00 PM', min:2, last:4, max:5, lev:'Gym near home + partner + preset playlist', score:3, goal1y:'Consistent 4×/wk', outcome:'Stronger body; more energy' },
      { output:'calls', period:'day', routine:'calls/day', block:'1:00–2:00 PM', min:2, last:5, max:10, lev:'Template + CRM queue + auto-dial', score:5, goal1y:'Close first 50 clients', outcome:'$8k MRR' }
    ];

    // ==== State ====
    window.velocityData = [];
    let currentIndex = -1;

    const els = {};
    function initEls(){
      ['velocityTable','vtList','m_n','m_edges','m_maint','m_lavg','maintSlider','maintOut','graph','edges','nodes','labels',
       'addRow','btnDeleteAll','actExportCsv','actExportPng',
       'vtEditor','vtForm','f_output','f_period','f_routine','f_block','f_min','f_last','f_max','f_lev','f_score','f_goal1y','f_outcome'
      ].forEach(k=> els[k]=$((k)));
    }

    // ==== Render Table/List ====
    function renderTable(){
      if (!els.velocityTable || !els.vtList) return; // safety guard
      const tbody = els.velocityTable.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const rows = window.velocityData;
      const upkeep = Number(els.maintSlider?.value||0);
      rows.forEach((r, idx)=>{
        const tr = document.createElement('tr');
        const dispScore = getDisplayScore(r, computeAutoScore(r, upkeep));
        tr.innerHTML = `
          <td>${r.outcome||'—'}</td>
          <td>${r.goal1y||'—'}</td>
          <td>${r.routine||'—'}</td>
          <td>${r.block||'—'}</td>
          <td>${r.min||0}</td>
          <td>${r.last||0}</td>
          <td>${r.max||0}</td>
          <td>${(r.lev||'')}</td>
          <td>${dispScore}</td>
        `;
        tr.style.cursor='pointer';
        tr.addEventListener('click', ()=> openEditor(idx));
        tbody.appendChild(tr);
      });

      // Mobile list
      els.vtList.innerHTML='';
      rows.forEach((r, idx)=>{
        const card = document.createElement('div');
        card.className='p-3 border rounded-3';
        card.style.background='#0f1626';
        const dispScore = getDisplayScore(r, computeAutoScore(r, Number(els.maintSlider?.value||0)));
        card.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-1">
            <strong>${r.routine||'—'}</strong>
            <span class="badge bg-secondary">Score: ${dispScore}</span>
          </div>
          <div class="small">${r.block||'—'} · Min ${r.min||0} / Last ${r.last||0} / Max ${r.max||0}</div>
          <div class="tiny mt-1">${r.lev||''}</div>
        `;
        card.addEventListener('click', ()=> openEditor(idx));
        els.vtList.appendChild(card);
      });
    }

    // ==== Graph ====
    function drawGraph(){
      const nodesG = $('nodes'), edgesG = $('edges'), labelsG = $('labels');
      if (!nodesG || !edgesG || !labelsG) return;
      edgesG.innerHTML = ''; nodesG.innerHTML=''; labelsG.innerHTML='';
      const rows = window.velocityData;
      const n = rows.length;
      if (!n) return;
      const upkeep = Number(els.maintSlider?.value||0);
      const cx=500, cy=320, R=230;
      const positions = rows.map((_,i)=>{
        const ang = (Math.PI*2*i)/n - Math.PI/2;
        return {x: cx + R*Math.cos(ang), y: cy + R*Math.sin(ang)};
      });

      for (let i=0;i<n;i++){
        for (let j=i+1;j<n;j++){
          const p1 = positions[i], p2 = positions[j];
          const e = document.createElementNS('http://www.w3.org/2000/svg','line');
          e.setAttribute('x1', p1.x); e.setAttribute('y1', p1.y);
          e.setAttribute('x2', p2.x); e.setAttribute('y2', p2.y);
          const w = Math.max(1.5, Math.min(6, 1 + (upkeep/40) + (n/6)));
          e.setAttribute('stroke-width', w.toFixed(1));
          e.setAttribute('stroke', '#6c7a99');
          e.setAttribute('opacity', '0.28');
          edgesG.appendChild(e);
        }
      }

      rows.forEach((r,i)=>{
        const p = positions[i];
        const autoScore = computeAutoScore(r, upkeep);
        const score = getDisplayScore(r, autoScore);
        const palette = ['#2b5569','#2b7a78','#20a5a5','#38c3c3','#7be3e3'];
        const idx = Math.max(1, Math.min(5, Math.round(Math.max(1, score)))) - 1;
        const fill = palette[idx];

        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', p.x); c.setAttribute('cy', p.y); c.setAttribute('r', 26);
        c.setAttribute('fill', fill);
        c.setAttribute('stroke', '#0b1220'); c.setAttribute('stroke-width','2');
        g.appendChild(c);
        nodesG.appendChild(g);

        const label = document.createElementNS('http://www.w3.org/2000/svg','text');
        label.setAttribute('x', p.x);
        label.setAttribute('y', p.y + 44);
        label.setAttribute('class','node-label');
        label.textContent = r.routine || '—';
        labelsG.appendChild(label);
      });
    }

    // ==== Metrics ====
    function refreshMetrics(){
      const rows = window.velocityData;
      const n = rows.length;
      const edges = n*(n-1)/2;
      const upkeep = Number(els.maintSlider?.value||0);
      const maint = n*upkeep;
      let sumScore=0, count=0;
      rows.forEach(r=>{
        const sc = getDisplayScore(r, computeAutoScore(r, upkeep));
        sumScore += sc; count++;
      });
      const avg = count? (sumScore/count).toFixed(2) : '—';
      $('m_n').textContent = n;
      $('m_edges').textContent = edges;
      $('m_maint').textContent = maint;
      $('m_lavg').textContent = avg;
      $('maintOut').textContent = upkeep;
    }

    // ==== Editor ====
    function openEditor(idx){
      currentIndex = idx;
      const r = window.velocityData[idx];
      if (!r) return;
      els.f_output.value = r.output||'';
      els.f_period.value = r.period||'day';
      els.f_routine.value = r.routine||'';
      els.f_block.value = r.block||'';
      els.f_min.value = r.min||0;
      els.f_last.value = r.last||0;
      els.f_max.value = r.max||0;
      els.f_lev.value = r.lev||'';
      // If leverage text is empty, force score = 0 for editing view
      els.f_score.value = (r.lev && String(r.lev).trim().length>0) ? (r.score ?? '') : 0;
      els.f_goal1y.value = r.goal1y||'';
      els.f_outcome.value = r.outcome||'';
      new bootstrap.Offcanvas(els.vtEditor).show();
    }

    function recomputeRoutineField(){
      const o = els.f_output.value.trim();
      const p = els.f_period.value.trim();
      els.f_routine.value = (o && p) ? `${o}/${p}` : '';
    }

    function collectEditor(){
      let levText = els.f_lev.value.trim();
      let scoreVal = Number(els.f_score.value);
      if (!levText){ scoreVal = 0; } // enforce rule
      return {
        output: els.f_output.value.trim(),
        period: els.f_period.value.trim(),
        routine: els.f_routine.value.trim(),
        block: els.f_block.value.trim(),
        min: Number(els.f_min.value)||0,
        last: Number(els.f_last.value)||0,
        max: Number(els.f_max.value)||0,
        lev: levText,
        score: Number.isFinite(scoreVal) ? scoreVal : 0,
        goal1y: els.f_goal1y.value.trim(),
        outcome: els.f_outcome.value.trim(),
      };
    }

    function bindEditor(){
      els.f_output.addEventListener('input', recomputeRoutineField);
      els.f_period.addEventListener('change', recomputeRoutineField);

      // If leverage text becomes empty, auto set score to 0; if non-empty and score is 0, nudge to 1
      els.f_lev.addEventListener('input', ()=>{
        const txt = els.f_lev.value.trim();
        if (!txt){
          els.f_score.value = 0;
        } else {
          if (Number(els.f_score.value) === 0) els.f_score.value = 1;
        }
      });

      $('saveRow').addEventListener('click', ()=>{
        if (currentIndex<0) return;
        const data = collectEditor();
        window.velocityData[currentIndex] = data;
        refreshAll();
        bootstrap.Offcanvas.getInstance(els.vtEditor)?.hide();
      });
      $('deleteRow').addEventListener('click', ()=>{
        if (currentIndex<0) return;
        window.velocityData.splice(currentIndex,1);
        refreshAll();
        bootstrap.Offcanvas.getInstance(els.vtEditor)?.hide();
      });
    }

    // ==== CSV Export (quoted fields, aligned to table headers) ====
    function csvQuote(val){
      const s = String(val ?? '');
      // Escape quotes by doubling them, then wrap the whole field in quotes
      return `"${s.replace(/"/g,'""')}"`;
    }
    function exportCsv(){
      const rows = window.velocityData;
      const upkeep = Number(els.maintSlider?.value||0);
      const header = [
        "Five Year Outcome",
        "1 Year Goal",
        "Routine",
        "Time Block",
        "Min",
        "Last",
        "Max",
        "Leverage",
        "Leverage Score (1–5)"
      ];
      const lines = [header.map(csvQuote).join(',')];
      rows.forEach(r=>{
        const row = [
          csvQuote(r.outcome||''),
          csvQuote(r.goal1y||''),
          csvQuote(r.routine||''),
          csvQuote(r.block||''),
          (Number(r.min)||0),
          (Number(r.last)||0),
          (Number(r.max)||0),
          csvQuote(r.lev||''),
          getDisplayScore(r, computeAutoScore(r, upkeep))
        ];
        lines.push(row.join(','));
      });
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'velocity_routines.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    // ==== PNG Export (Velocity Table card) ====
    function exportPng(){
      try{
        const tableCard = document.querySelector('.vt-table');
        const target = tableCard || $('velocityTable');
        if (!target) throw new Error('Velocity table not found');
        html2canvas(target, {
          useCORS: true,
          backgroundColor: '#0b1220',
          scale: (window.devicePixelRatio || 2)
        }).then(canvas=>{
          const a = document.createElement('a');
          a.href = canvas.toDataURL('image/png');
          a.download = 'velocity_table.png';
          a.click();
        }).catch(err=>{
          console.error('PNG export failed:', err);
          alert('PNG export failed. Try desktop or allow cross-origin images.');
        });
      }catch(e){
        console.error(e);
        alert('PNG export not available on this view.');
      }
    }

    
    // ==== CSV Import ====
    function normalizeHeader(h){
      return String(h||'').trim().toLowerCase();
    }
    function parseCsvText(text){
      const rows = [];
      let i=0, field='', row=[], inQuotes=false;
      for (i=0; i<text.length; i++){
        const c = text[i];
        if (inQuotes){
          if (c === '"'){
            if (text[i+1] === '"'){ field += '"'; i++; }
            else { inQuotes = false; }
          } else { field += c; }
        } else {
          if (c === '"'){ inQuotes = true; }
          else if (c === ','){ row.push(field); field=''; }
          else if (c === '\n' || c === '\r'){
            if (c === '\r' && text[i+1] === '\n') i++;
            row.push(field); field='';
            if (row.length>1 || row[0] !== '') rows.push(row);
            row = [];
          } else { field += c; }
        }
      }
      if (field.length || row.length){ row.push(field); rows.push(row); }
      return rows;
    }
    function importCsvRows(rows){
      if (!rows || !rows.length) return;
      const headers = rows[0].map(normalizeHeader);
      const dataRows = rows.slice(1);
      const idx = (name)=> headers.indexOf(normalizeHeader(name));

      const mapIdx = {
        outcome: [idx("five year outcome"), idx("5 year outcome"), idx("five-year outcome")].find(i=>i>=0),
        goal1y: [idx("1 year goal"), idx("one year goal"), idx("1y goal")].find(i=>i>=0),
        routine: idx("routine"),
        block: [idx("time block"), idx("block")].find(i=>i>=0),
        min: idx("min"),
        last: idx("last"),
        max: idx("max"),
        lev: [idx("leverage"), idx("leverage (text)")].find(i=>i>=0),
        score: [idx("leverage score (1–5)"), idx("leverage score"), idx("score")].find(i=>i>=0),
        output: idx("output"),
        period: idx("period"),
      };

      const imported = [];
      dataRows.forEach(r=>{
        const get = (k)=>{
          const i = mapIdx[k];
          if (i === undefined || i < 0 || i >= r.length) return "";
          return r[i];
        };
        const toNum = (v)=>{
          const n = Number(String(v||"").trim());
          return Number.isFinite(n) ? n : 0;
        };
        const levText = String(get('lev')||'').trim();
        let scoreVal = toNum(get('score'));
        if (!levText){ scoreVal = 0; }

        imported.push({
          output: String(get('output')||'').trim(),
          period: String(get('period')||'').trim() || 'day',
          routine: String(get('routine')||'').trim(),
          block: String(get('block')||'').trim(),
          min: toNum(get('min')),
          last: toNum(get('last')),
          max: toNum(get('max')),
          lev: levText,
          score: scoreVal,
          goal1y: String(get('goal1y')||'').trim(),
          outcome: String(get('outcome')||'').trim(),
        });
      });

      window.velocityData = imported;
      refreshAll();
      alert(`Imported ${imported.length} row(s).`);
    }
    function handleImportFile(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const text = String(e.target.result||"");
          const rows = parseCsvText(text);
          importCsvRows(rows);
        }catch(err){
          console.error(err);
          alert('Import failed. Ensure it is a CSV with headers.');
        }
      };
      reader.readAsText(file);
    }
    function bindImport(){
      const btn = $('btnImport');
      const file = $('fileCsv');
      if (!btn || !file) return;
      btn.addEventListener('click', ()=> file.click());
      file.addEventListener('change', (e)=>{
        if (e.target.files && e.target.files[0]) handleImportFile(e.target.files[0]);
        e.target.value = '';
      });
    }

    // ==== CSV Prompt (generator) ====
    function updateCsvPrompt(){
      const headers = [
        "Five Year Outcome",
        "1 Year Goal",
        "Routine",
        "Time Block",
        "Min",
        "Last",
        "Max",
        "Leverage",
        "Leverage Score (1–5)",
        "Output",
        "Period"
      ];
      const templateRow = [
        "Nonfiction book + lead gen",
        "Publish 12 long-form essays",
        "words/day",
        "5:30–7:00 AM",
        "300",
        "700",
        "1200",
        "AI outline + Pomodoro + keyboard macro",
        "4",
        "words",
        "day"
      ];
      const csvHeader = headers.map(h => `"${h.replace(/"/g,'""')}"`).join(',');
      const csvExample = templateRow.map(h => `"${h.replace(/"/g,'""')}"`).join(',');
      const prompt = [
        "Create a CSV for my Daily Routine Builder with EXACT headers and one row per routine.",
        "",
        "Headers (first row):",
        csvHeader,
        "",
        "Rules:",
        "• Leave any missing/unknown values blank (or 0 for Min/Last/Max/Score).",
        "• If Leverage is blank, set Leverage Score to 0.",
        "• Use standard time ranges like 5:00–7:00 AM (no military time).",
        "• Optional: include Output and Period so Routine can be `output/period` (e.g., words/day).",
        "",
        "Example (second row):",
        csvExample,
        "",
        "Now generate the CSV with my routines."
      ].join("\n");
      const area = $('promptCsv');
      if (area) area.value = prompt;
    }
    function bindCsvPromptCopy(){
      const btn = $('copyPromptCsv');
      const area = $('promptCsv');
      const st = $('copyStatusCsv');
      if (!btn || !area) return;
      btn.addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText(area.value);
          if (st){ st.classList.remove('d-none'); setTimeout(()=>st.classList.add('d-none'), 1200); }
        }catch(e){ alert('Copy failed'); }
      });
    }


    // ==== Actions ====
    function bindRowActions(){
      $('addRow').addEventListener('click', ()=>{
        window.velocityData.push({output:'',period:'day',routine:'',block:'',min:0,last:0,max:0,lev:'',score:0,goal1y:'',outcome:''});
        refreshAll();
      });
      $('btnDeleteAll').addEventListener('click', ()=>{
        if (!confirm('Delete all routines?')) return;
        window.velocityData = [];
        refreshAll();
      });
    }

    function bindExports(){
      $('actExportCsv').addEventListener('click', (e)=>{ e.preventDefault(); exportCsv(); });
      $('actExportPng').addEventListener('click', (e)=>{ e.preventDefault(); exportPng(); });
    }

    function updatePrompt(){
      const per = Number($('maintSlider')?.value || 0);
      const rows = (window.velocityData||[]);
      const n = rows.length;
      const edges = (n * (n - 1)) / 2;
      const totalMaint = n * per;

      const lines = [];
      lines.push("You are my execution strategist. Use the Socratic method. Goal: increase leverage (0–5) on each routine and reduce interdependencies we can control. Keep me honest, no fluff.");
      lines.push("");
      lines.push("Context:");
      lines.push(`• Processes (n): ${n}`);
      lines.push(`• Interdependencies (complete graph): n(n−1)/2 = ${n}×${n-1}/2 = ${edges}`);
      lines.push(`• Upkeep per task (mins): ${per}`);
      lines.push(`• Total daily maintenance (mins): n×upkeep = ${n}×${per} = ${totalMaint}`);
      lines.push("");
      if (rows.length){
        lines.push("Routines:");
        rows.forEach((r, i) => {
          const autoScore = computeAutoScore(r, per);
          const disp = getDisplayScore(r, autoScore);
          const tag = unitTagFor(r);
          lines.push(`  ${i+1}. ${r.routine||'—'} | Block: ${r.block||'—'} | Min: ${r.min||'—'}${tag} | Last: ${r.last||'—'}${tag} | Max: ${r.max||'—'}${tag} | Leverage: ${(r.lev||'')} | Score: ${disp} | 1Y: ${(r.goal1y||'—')} | 5Y: ${(r.outcome||'—')}`);
        });
      } else {
        lines.push("No routines yet.");
      }
      lines.push("");
      lines.push("What I want from you:");
      lines.push("1) For each routine, ask 3–5 short questions to uncover practical leverage I can add today. Then propose a target level (0–5) with rationale.");
      lines.push("2) Scan for preventable interdependencies given edges≈n(n−1)/2 and my current blocks; suggest simple ways to decouple (batching, automation, schedule shifts).");
      lines.push("3) Prioritize 1–3 highest-leverage changes with the biggest reduction in maintenance or coordination cost. Show expected impact on score and edges.");
      $('promptArea').value = lines.join('\n');
    }

    function refreshAll(){
      renderTable();
      drawGraph();
      refreshMetrics();
      updatePrompt();
    }

    // ==== Init ====
    window.addEventListener('DOMContentLoaded', ()=>{
      initEls();

      // Force-load dummy routines on every page open (stateless; no localStorage)
      window.velocityData = Array.isArray(SAMPLE_ROWS)
        ? SAMPLE_ROWS.map(r => ({ ...r }))
        : [];

      bindRowActions();
      bindEditor();
      bindExports();
      bindImport();
      bindCsvPromptCopy();
      $('maintSlider')?.addEventListener('input', refreshAll);
      refreshAll();
      setInterval(updatePrompt, 1500);
      updateCsvPrompt();
    });
  </script>
</body>
</html>
